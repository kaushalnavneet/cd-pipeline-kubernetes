apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: build-base-pipeline
spec:
  params:
    - name: imageName
      description: the name of the output docker image
    - name: imageTag
      description: the tag for the output docker image
    - name: accountApiKey1416501
      description: api key
    - name: accountApiKey1308775
      description: api key for docker build machine
    - name: crRegion
      description: the CR region to use
    - name: crAccountName
      description: the CR account name to use
    - name: idsToken
      description: the ids token to use to clone repos
    - name: registryUrl
      description: the CR registry URL to use
    - name: registryNamespace
      description: the CR NS to use 
    - name: charts_repo
      description: The charts repo url
    - name: config_repo
      description: The config repo url    
  tasks:
  - name: deploy
    taskRef:
      name:  build-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageName
        value: cd-deploy-base
      - name: imageTag
        value: deploy
      - name: tagSuffix
        value: ''
      - name: charts_repo
        value: $(params.charts_repo)
      - name: config_repo
        value: $(params.config_repo)
  - name: nodejs10
    taskRef:
      name: build-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageName
        value: cd-build-base
      - name: imageTag
        value: nodejs10
      - name: charts_repo
        value: $(params.charts_repo)
      - name: config_repo
        value: $(params.config_repo)
  - name: java
    taskRef:
      name: build-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageName
        value: cd-build-base
      - name: imageTag
        value: java
      - name: charts_repo
        value: $(params.charts_repo)
      - name: config_repo
        value: $(params.config_repo)
  - name: go 
    taskRef:
      name: build-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageName
        value: cd-build-base
      - name: imageTag
        value: go1.10
      - name: charts_repo
        value: $(params.charts_repo)
      - name: config_repo
        value: $(params.config_repo)
  - name: nodejs10-run 
    runAfter: [nodejs10]
    taskRef:
      name: run-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: accountApiKey1308775
        value: $(params.accountApiKey1308775)
      - name: dockerPassword
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageUrl
        value: us.icr.io/opentoolchain/ibmnode
      - name: runBaseImage
        value: us.icr.io/opentoolchain/cd-build-base:nodejs10
      - name: dockerFile
        value: docker/Dockerfile.nodejs10.run
      - name: imageTag
        value: 10secure
  - name: websphere-liberty-run
    runAfter: [java]
    taskRef:
      name: run-base
    params:
      - name: accountApiKey1416501
        value: $(params.accountApiKey1416501)
      - name: accountApiKey1308775
        value: $(params.accountApiKey1308775)
      - name: dockerPassword
        value: $(params.accountApiKey1416501)
      - name: idsToken
        value: $(params.idsToken)
      - name: imageUrl
        value: us.icr.io/opentoolchain/websphere-liberty
      - name: runBaseImage
        value: us.icr.io/opentoolchain/cd-build-base:java
      - name: dockerFile
        value: docker/Dockerfile.java.run
      - name: imageTag
        value: secure
