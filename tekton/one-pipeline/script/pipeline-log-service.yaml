version: '1'

setup:
  image: us.icr.io/opentoolchain/cd-build-base:nodejs12ubi
  configmap: cd-config
  script: |
    #!/usr/bin/env bash

    echo ">>>>>>>>>>>>>>>>>>>"
    CONFIG_REPO=$(cat /config/CONFIG_REPO)
    CONFIG_BRANCH=$(cat /config/CONFIG_BRANCH)
    CONFIG_DIRECTORY=$(cat /config/CONFIG_DIRECTORY)
    echo $CONFIG_REPO $CONFIG_BRANCH $CONFIG_DIRECTORY

    IDS_TOKEN=$(cat /config/IDS_TOKEN)
    echo "echo -n $IDS_TOKEN" > ./token.sh
    chmod +x ./token.sh
    GIT_ASKPASS=./token.sh git clone --single-branch --branch ${CONFIG_BRANCH} ${CONFIG_REPO}   
    
    echo ">>>>>>>>>>>>>>>>>>>"


test:
  abort_on_failure: false
  configmap: cd-config
  image: us.icr.io/opentoolchain/cd-build-base:nodejs12ubi
  script: |
    #!/usr/bin/env bash

    echo "Tests"

containerize:
  dind: true
  configmap: cd-config
  image: us.icr.io/opentoolchain/cd-build-base:nodejs12ubi
  script: |
    #!/usr/bin/env bash

    if [[ "$PIPELINE_DEBUG" == 1 ]]; then
      trap env EXIT
      env
      set -x
    fi

    source ./tekton/one-pipeline/script/scripts/build.sh

deploy:
  image: us.icr.io/opentoolchain/cd-build-base:nodejs12ubi
  configmap: cd-config
  script: |
    #!/usr/bin/env bash

    if [[ "$PIPELINE_DEBUG" == 1 ]]; then
      trap env EXIT
      env
      set -x
    fi

    source scripts/deploy_setup.sh
    source scripts/deploy.sh

acceptance-test:
  abort_on_failure: false
  image: icr.io/continuous-delivery/pipeline/pipeline-base-image:2.7@sha256:282677e79ccb9d20c699d384a54093894de03675752cd848a3133266c898c14c
  script: |
    #!/usr/bin/env bash

    source /root/.nvm/nvm.sh
    npm ci
    export APP_URL=$(cat ../app-url)
    npm run acceptance-test

release:
  image: wcp-compliance-automation-team-docker-local.artifactory.swg-devops.com/ibm-compliance-automation:1.2.4@sha256:dc98cc52c0caede42149c08727147520e30e81fee543b8dd5939b45d06baa142
  script: |
    #!/usr/bin/env bash

    source scripts/release.sh
