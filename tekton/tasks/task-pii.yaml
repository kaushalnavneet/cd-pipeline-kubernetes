apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-pii
spec:
  params:
    - name: source_directory
    - name: runBaseImage
    - name: javaPattern
      default: 'false'
  stepTemplate:
    env:
      - name: NLS_FILE_PATTERN
        valueFrom:
          configMapKeyRef:
            name: cd-config
            key: NLS_FILE_PATTERN
      - name: NLS_FOLDER_PATTERN
        valueFrom:
          configMapKeyRef:
            name: cd-config
            key: NLS_FOLDER_PATTERN
  workspaces:
  - name: task-pvc
    mountPath: /workspace 
  steps:
  - name: run-pii
    image: $(params.runBaseImage)
    imagePullPolicy: IfNotPresent
    env:
      - name: HOME
        value: "/root"
      - name: SOURCE_DIRECTORY
        value: $(params.source_directory)
      - name: SKIP
        value: "false"
      - name: JAVA_PATTERN
        value: $(params.javaPattern)
    workingDir: /workspace
    command: ["/bin/bash", "-c"]
    args:
      - | 
        export HOME=/root
        #set -e
        if [ "${SKIP}" == true ]; then
          echo "Skipping PII"
          exit 0
        fi
        cd "${SOURCE_DIRECTORY}"
        if [ "$JAVA_PATTERN" = true ]; then
          export NLS_FOLDER_PATTERN=resources
          export NLS_FILE_PATTERN=Language_en.properties
        fi
        pii/run
